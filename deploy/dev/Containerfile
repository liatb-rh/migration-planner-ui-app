# Multi-stage build with layers caching optimization for Migration Planner UI standalone app

# Build stage
FROM --platform=linux/amd64 registry.access.redhat.com/ubi9/nodejs-22-minimal AS builder
# Install system dependencies first (rarely changes)
USER 0
RUN microdnf install -y make git && microdnf clean all
# Switch to container user
USER 1001
WORKDIR ${APP_ROOT}
# Copy package files only
COPY --chown=1001:0 package.json package-lock.json ./
# Install npm dependencies (cached unless package files change)
RUN npm install --no-audit --no-fund
# Copy source code (invalidates on any source change)
COPY --chown=1001:0 . .
# Build argument - placed just before it's needed
ARG USE_MIGRATION_PLANNER_API=false
ENV USE_MIGRATION_PLANNER_API=${USE_MIGRATION_PLANNER_API}
# Build the standalone application
RUN npm run build:standalone

# Runtime stage
FROM --platform=linux/amd64 registry.access.redhat.com/ubi9/nginx-126 AS runtime
# Copy nginx configuration first (changes less often than built app)
COPY --from=builder ${APP_ROOT}/deploy/dev/nginx.conf /etc/nginx/nginx.conf
# Copy built application from builder stage
COPY --from=builder ${APP_ROOT}/dev/dist /usr/share/nginx/html
# Expose port 8081 (nginx default for non-root)
EXPOSE 8081

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
